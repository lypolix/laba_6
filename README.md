# laba_6

# Лабораторная работа 6: Рефакторинг checkout

## Цель работы: научиться находить проблемы качества (code smells) в реальном коде, выполнять рефакторинг маленькими шагами, применять DRY/KISS на практике и сохранять поведение программы при изменении структуры (все тесты должны продолжать проходить).

## Какие проблемы качества были найдены:
В исходной версии функция process_checkout была слишком длинной и выполняла сразу несколько задач: разбор запроса, валидацию входных данных, расчёт subtotal, расчёт скидки, расчёт налога, генерацию order_id и сбор результата. Логика скидок была реализована большим блоком if/elif, который сложно быстро прочитать и безопасно изменять. В коде использовались магические числа (проценты скидок, пороги, ставка налога, фиксированные скидки), из-за чего смысл значений был неочевиден. Проверки, вычисления и форматирование результата были перемешаны, что ухудшало читаемость и усложняло точечные изменения (например, заменить ставку налога или добавить новый купон). Также код плохо масштабировался: добавление нового правила приводило бы к росту основной функции и повышало риск ошибок.

## Какие рефакторинги были применены:
Код был разбит на отдельные небольшие функции по зонам ответственности: parse_request (разбор входного словаря), validate_request (валидация обязательных полей и элементов items), calculate_subtotal (подсчёт subtotal), calculate_discount (логика скидок по купонам), calculate_tax (расчёт налога), generate_order_id (формирование идентификатора заказа). Магические числа были вынесены в именованные константы (ставка налога, проценты скидок, пороги, фиксированные значения), чтобы сделать правила явными и упростить изменение бизнес-логики. Основная функция process_checkout была переписана так, чтобы читаться сверху вниз как сценарий: разобрать входные данные → провалидировать → посчитать subtotal → посчитать скидку → применить скидку → посчитать налог → собрать ответ. Рефакторинг выполнялся без изменения поведения: все существующие тесты должны проходить без изменений.

## Что стало проще читать и менять:
Стало проще понимать общий поток обработки заказа, потому что process_checkout теперь описывает последовательность шагов и не содержит длинных вложенных условий. Стало проще менять бизнес-правила: например, ставку налога или параметры купонов можно корректировать в одном месте (в константах или в calculate_discount), не рискуя затронуть валидацию или сбор результата. Стало проще добавлять новые купоны: добавляется новая ветка в calculate_discount, при этом остальной код не меняется. Стало проще тестировать отдельные части логики при необходимости, потому что расчёт subtotal, скидки и налога теперь отделены и могут быть покрыты отдельными unit-тестами.

## Проверка:
Запуск всех тестов выполняется командой pytest из корня проекта. 

